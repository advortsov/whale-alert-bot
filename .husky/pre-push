#!/bin/sh
set -e

ZERO_SHA="0000000000000000000000000000000000000000"
MIGRATIONS_CHANGED="0"

while read -r LOCAL_REF LOCAL_SHA REMOTE_REF REMOTE_SHA; do
  if [ -z "$LOCAL_SHA" ] || [ "$LOCAL_SHA" = "$ZERO_SHA" ]; then
    continue
  fi

  if [ "$REMOTE_SHA" = "$ZERO_SHA" ]; then
    RANGE="$LOCAL_SHA"
  else
    RANGE="$REMOTE_SHA..$LOCAL_SHA"
  fi

  if git diff --name-only "$RANGE" -- database/migrations | grep -q .; then
    MIGRATIONS_CHANGED="1"
    break
  fi
done

if [ "$MIGRATIONS_CHANGED" = "1" ]; then
  echo "Detected changes in database/migrations/*, running db:validate..."
  npm run db:validate
else
  echo "No migration changes detected, skipping db:validate."
fi
