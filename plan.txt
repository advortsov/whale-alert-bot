⏺ Да, план готов. Краткое содержание:

  13 эндпоинтов в 4 группах:
  - Auth (2) — JWT через Telegram Login Widget, refresh tokens
  - Wallets (7) — CRUD + mute + filters + history
  - Settings (2) — GET/PATCH все настройки
  - Status (1) — статус пользователя с квотой

  Рефакторинг сервисов: добавляем structured-методы (возвращают типизированные объекты), существующие string-методы становятся обёртками → Telegram-хендлеры не ломаются.

  Новая зависимость: только @nestjs/jwt. Верификация Telegram Login Widget — через встроенный node:crypto.

  Без миграций БД — stateless JWT, используем существующую таблицу users.

⏺ User approved Claude's plan
  ⎿  Plan saved to: ~/.claude/plans/starry-shimmying-hare.md · /plan to edit
     REST API для whale-alert-bot

     Контекст

     ApiModule пуст. Бизнес-логика доступна только через Telegram-бота. Нужен полный REST API per ADR-001 с JWT-аутентификацией через Telegram Login Widget.

     Проблема: сервисы WhalesModule возвращают Promise<string> (форматированный текст для Telegram). Для JSON API нужны структурированные данные.

     Новые зависимости

     - @nestjs/jwt — стандарт NestJS для JWT (signing/verification)

     Telegram Login Widget верификация — через встроенный node:crypto.

     Структура файлов

     src/modules/api/
     ├── api.module.ts                          # Module wiring
     ├── auth/
     │   ├── auth.controller.ts                 # POST /api/auth/telegram, /api/auth/refresh
     │   ├── auth.service.ts                    # Telegram verification, JWT issuance
     │   ├── jwt-auth.guard.ts                  # Custom NestJS guard
     │   └── auth.interfaces.ts                 # IAuthTokens, ITelegramLoginData, IJwtPayload
     ├── controllers/
     │   ├── wallets.controller.ts              # CRUD wallets + mute + filters + history
     │   ├── settings.controller.ts             # GET/PATCH settings
     │   └── status.controller.ts              # GET status
     ├── dto/
     │   ├── telegram-login.dto.ts              # Zod schema для Telegram Login Widget
     │   ├── track-wallet.dto.ts                # { chainKey, address, label? }
     │   ├── mute-wallet.dto.ts                 # { minutes }
     │   ├── wallet-filter.dto.ts               # { target, enabled }
     │   ├── history-query.dto.ts               # { limit?, offset?, kind?, direction? }
     │   ├── update-settings.dto.ts             # Partial settings object
     │   └── refresh-token.dto.ts               # { refreshToken }
     └── responses/
         ├── wallet.responses.ts                # ITrackWalletResponse, IWalletListResponse, IWalletDetailsResponse
         ├── settings.responses.ts              # IUserSettingsResponse, IUserStatusResponse
         └── history.responses.ts               # IHistoryPageResponse

     src/modules/whales/
     ├── interfaces/
     │   ├── tracking-wallets.result.ts         # Structured result types
     │   ├── tracking-settings.result.ts        # Structured result types
     │   └── tracking-history.result.ts         # Structured result types
     ├── services/
     │   ├── tracking-wallets.service.ts        # +structured methods, existing → wrappers
     │   ├── tracking-settings.service.ts       # +structured methods, existing → wrappers
     │   ├── tracking-history.service.ts        # +structured methods
     │   └── tracking.service.ts               # +structured facade methods

     Эндпоинты (13)

     Auth (2)
     ┌────────┬────────────────────┬──────────────────────────────────────────────────────────┬───────────────────────────────┐
     │ Method │        Path        │                        Body/Query                        │           Response            │
     ├────────┼────────────────────┼──────────────────────────────────────────────────────────┼───────────────────────────────┤
     │ POST   │ /api/auth/telegram │ { id, first_name, username, photo_url, auth_date, hash } │ { accessToken, refreshToken } │
     ├────────┼────────────────────┼──────────────────────────────────────────────────────────┼───────────────────────────────┤
     │ POST   │ /api/auth/refresh  │ { refreshToken }                                         │ { accessToken, refreshToken } │
     └────────┴────────────────────┴──────────────────────────────────────────────────────────┴───────────────────────────────┘
     Wallets (7)
     ┌────────┬──────────────────────────┬───────────────────────────────┬───────────────────────────────────────────────┐
     │ Method │           Path           │          Body/Query           │                   Response                    │
     ├────────┼──────────────────────────┼───────────────────────────────┼───────────────────────────────────────────────┤
     │ POST   │ /api/wallets             │ { chainKey, address, label? } │ { walletId, address, label, chainKey, isNew } │
     ├────────┼──────────────────────────┼───────────────────────────────┼───────────────────────────────────────────────┤
     │ GET    │ /api/wallets             │ —                             │ { wallets: [...], totalCount }                │
     ├────────┼──────────────────────────┼───────────────────────────────┼───────────────────────────────────────────────┤
     │ GET    │ /api/wallets/:id         │ —                             │ { wallet details + preferences + events }     │
     ├────────┼──────────────────────────┼───────────────────────────────┼───────────────────────────────────────────────┤
     │ DELETE │ /api/wallets/:id         │ —                             │ { walletId, address, chainKey }               │
     ├────────┼──────────────────────────┼───────────────────────────────┼───────────────────────────────────────────────┤
     │ POST   │ /api/wallets/:id/mute    │ { minutes }                   │ { walletId, mutedUntil }                      │
     ├────────┼──────────────────────────┼───────────────────────────────┼───────────────────────────────────────────────┤
     │ GET    │ /api/wallets/:id/filters │ —                             │ WalletAlertFilterState                        │
     ├────────┼──────────────────────────┼───────────────────────────────┼───────────────────────────────────────────────┤
     │ PATCH  │ /api/wallets/:id/filters │ { target, enabled }           │ WalletAlertFilterState                        │
     └────────┴──────────────────────────┴───────────────────────────────┴───────────────────────────────────────────────┘
     Wallet History (1)
     ┌────────┬──────────────────────────┬────────────────────────────────┬─────────────────────────────────────────────────────────┐
     │ Method │           Path           │             Query              │                        Response                         │
     ├────────┼──────────────────────────┼────────────────────────────────┼─────────────────────────────────────────────────────────┤
     │ GET    │ /api/wallets/:id/history │ limit, offset, kind, direction │ { events, resolvedAddress, limit, offset, hasNextPage } │
     └────────┴──────────────────────────┴────────────────────────────────┴─────────────────────────────────────────────────────────┘
     Settings (2)
     ┌────────┬───────────────┬─────────────────────────────────────────────────────────┬───────────────────────────┐
     │ Method │     Path      │                          Body                           │         Response          │
     ├────────┼───────────────┼─────────────────────────────────────────────────────────┼───────────────────────────┤
     │ GET    │ /api/settings │ —                                                       │ { preferences, settings } │
     ├────────┼───────────────┼─────────────────────────────────────────────────────────┼───────────────────────────┤
     │ PATCH  │ /api/settings │ partial { thresholdUsd?, cexFlowMode?, timezone?, ... } │ { preferences, settings } │
     └────────┴───────────────┴─────────────────────────────────────────────────────────┴───────────────────────────┘
     Status (1)
     ┌────────┬─────────────┬─────────────────────────────────────────┐
     │ Method │    Path     │                Response                 │
     ├────────┼─────────────┼─────────────────────────────────────────┤
     │ GET    │ /api/status │ { preferences, settings, historyQuota } │
     └────────┴─────────────┴─────────────────────────────────────────┘
     Рефакторинг сервисов

     Подход: добавляем structured-методы, существующие string-методы становятся обёртками.

     TrackingWalletsService — новые методы

     trackWallet(userRef, address, label, chainKey) → ITrackWalletResult
     listWallets(userRef) → IWalletListResult
     getWalletDetail(userRef, walletId) → IWalletDetailResult
     removeWallet(userRef, walletId) → IUntrackResult
     muteWallet(userRef, walletId, minutes, source) → IMuteWalletResult

     Существующие trackAddress(), listTrackedAddresses(), getWalletDetails(), untrackAddress(), muteWalletAlertsForDuration() → вызывают structured-метод + форматируют.

     TrackingSettingsService — новые методы

     getSettings(userRef) → IUserSettingsResult
     getStatus(userRef) → IUserStatusResult
     updateThreshold(userRef, value: number) → IUserSettingsResult
     updateMute(userRef, minutes: number | null) → { mutedUntil: Date | null }
     updateCexFlow(userRef, mode) → IUserSettingsResult
     updateSmartFilter(userRef, type) → IUserSettingsResult
     updateIncludeDex(userRef, dexes) → IUserSettingsResult
     updateExcludeDex(userRef, dexes) → IUserSettingsResult
     updateQuietHours(userRef, from, to) → IUserSettingsResult
     updateTimezone(userRef, tz) → IUserSettingsResult
     updateEventTypeFilter(userRef, target, enabled) → IUserSettingsResult

     Существующие string-методы → вызывают structured + форматируют.

     TrackingHistoryService — новые методы

     getHistoryPage(userRef, walletId, params) → IHistoryPageResult

     Реюзает getAddressHistoryPageWithPolicy, но принимает walletId вместо rawAddress.

     TrackingService (фасад) — новые методы

     Делегирует к sub-сервисам аналогично существующим.

     Структурированные типы (src/modules/whales/interfaces/)

     tracking-wallets.result.ts

     interface ITrackWalletResult {
       walletId: number; address: string; label: string | null;
       chainKey: ChainKey; isNewSubscription: boolean;
     }
     interface IWalletSummary {
       walletId: number; address: string; label: string | null;
       chainKey: ChainKey; createdAt: Date;
     }
     interface IWalletListResult { wallets: readonly IWalletSummary[]; totalCount: number; }
     interface IWalletDetailResult {
       walletId: number; address: string; label: string | null; chainKey: ChainKey;
       globalPreferences: UserAlertPreferences;
       walletPreferences: { allowTransfer: boolean; allowSwap: boolean; hasOverride: boolean } | null;
       settings: UserAlertSettingsSnapshot;
       activeMute: Date | null;
       recentEvents: readonly WalletEventHistoryView[];
     }
     interface IUntrackResult { walletId: number; address: string; chainKey: ChainKey; }
     interface IMuteWalletResult { walletId: number; mutedUntil: Date; }

     tracking-settings.result.ts

     interface IUserSettingsResult {
       preferences: UserAlertPreferences;
       settings: UserAlertSettingsSnapshot;
     }
     interface IUserStatusResult extends IUserSettingsResult {
       historyQuota: { minuteUsed: number; minuteLimit: number; minuteRemaining: number; };
     }

     tracking-history.result.ts

     interface IHistoryPageResult {
       events: readonly WalletEventHistoryView[];
       resolvedAddress: string;
       walletId: number | null;
       limit: number; offset: number;
       kind: HistoryKind; direction: HistoryDirectionFilter;
       hasNextPage: boolean;
     }

     Аутентификация

     Telegram Login Widget verification (auth.service.ts)

     1. Получаем { id, first_name, last_name?, username?, photo_url?, auth_date, hash }
     2. Проверяем auth_date не старше 5 минут
     3. Собираем data_check_string: сортируем поля (кроме hash) по алфавиту, join \n
     4. secret_key = HMAC-SHA256("WebAppData", bot_token) // Для Login Widget: SHA256(bot_token)
     5. Сравниваем HMAC-SHA256(data_check_string, secret_key) с hash
     6. findOrCreate user по telegramId
     7. Возвращаем { accessToken (15min), refreshToken (7d) }

     JWT payload (IJwtPayload)

     { sub: string; username: string | null; type: 'access' | 'refresh' }

     JwtAuthGuard (jwt-auth.guard.ts)

     - Custom CanActivate guard
     - Читает Authorization: Bearer <token>
     - Верифицирует JWT через JwtService
     - Проверяет type === 'access'
     - Создаёт TelegramUserRef из payload, помещает в request.user

     Конфигурация

     - JWT_SECRET — новая env-переменная в AppConfigService
     - JWT_ACCESS_TTL = 900 (15 min)
     - JWT_REFRESH_TTL = 604800 (7 days)

     DTOs (Zod schemas)

     telegram-login.dto.ts

     z.object({
       id: z.number(),
       first_name: z.string(),
       last_name: z.string().optional(),
       username: z.string().optional(),
       photo_url: z.string().optional(),
       auth_date: z.number(),
       hash: z.string(),
     })

     track-wallet.dto.ts

     z.object({
       chainKey: z.enum(['ethereum_mainnet', 'solana_mainnet', 'tron_mainnet']),
       address: z.string().min(1),
       label: z.string().max(50).optional(),
     })

     update-settings.dto.ts

     z.object({
       thresholdUsd: z.number().min(0).optional(),
       mutedMinutes: z.number().min(0).nullable().optional(),
       cexFlowMode: z.enum(['off', 'in', 'out', 'all']).optional(),
       smartFilterType: z.enum(['all', 'buy', 'sell', 'transfer']).optional(),
       includeDexes: z.array(z.string()).optional(),
       excludeDexes: z.array(z.string()).optional(),
       quietHoursFrom: z.string().nullable().optional(),
       quietHoursTo: z.string().nullable().optional(),
       timezone: z.string().optional(),
       allowTransfer: z.boolean().optional(),
       allowSwap: z.boolean().optional(),
     }).refine(obj => Object.keys(obj).length > 0)

     Module wiring (api.module.ts)

     @Module({
       imports: [
         JwtModule.register({ secret: config.jwtSecret, signOptions: { expiresIn: '15m' } }),
         WhalesModule,
         DatabaseModule,  // for UsersRepository
       ],
       controllers: [AuthController, WalletsController, SettingsController, StatusController],
       providers: [AuthService, JwtAuthGuard],
     })
     export class ApiModule {}

     WhalesModule.exports нужно расширить: добавить TrackingService (если не экспортирован).

     Тесты

     - auth.service.spec.ts — верификация Telegram hash, генерация JWT, refresh flow
     - wallets.controller.spec.ts — все wallet endpoints, mock TrackingService
     - settings.controller.spec.ts — GET/PATCH settings
     - status.controller.spec.ts — GET status
     - jwt-auth.guard.spec.ts — valid/invalid/expired tokens

     Верификация

     1. npm run lint — без ошибок
     2. npm run typecheck — без ошибок
     3. npm run test — все тесты проходят (старые + новые)
     4. npm run build — сборка без ошибок
     5. docker compose up --build -d — контейнер стартует
     6. curl http://localhost:3000/health — OK
