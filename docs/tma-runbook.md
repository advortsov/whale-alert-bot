# TMA Runbook

## 1. –¶–µ–ª—å

–î–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç rollout Telegram Mini App (TMA) –¥–ª—è Whale Alert Bot:

1. backend API (`/api/auth/tma`, `/api/tma/init`),
2. frontend SPA (`/tma/`),
3. –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –∫–Ω–æ–ø–æ–∫ –≤ Telegram-–±–æ—Ç–µ,
4. —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –æ—Ç–∫–∞—Ç.

## 2. –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ env

–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

```env
TMA_ENABLED=true
TMA_BASE_URL=https://1303118-cr22992.tw1.ru/tma/
TMA_BOT_USERNAME=whale_alert_test_bot
TMA_ALLOWED_ORIGINS=https://1303118-cr22992.tw1.ru
```

–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:

1. `TMA_ENABLED=false` –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å —Ç–µ–∫—É—â–∏–π runtime.
2. `TMA_BASE_URL` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è `web_app` –∫–Ω–æ–ø–æ–∫ (`/app`, `/wallet #id`).
3. –ë–æ—Ç –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç root URL —Å –∑–∞–≤–µ—Ä—à–∞—é—â–∏–º `/`, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ `302` —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –∏ –ø–æ—Ç–µ—Ä–∏ `initData`.
4. `TMA_BOT_USERNAME` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è deep-link –∫–Ω–æ–ø–∫–∏ `üì± TMA` –≤ live-alert.
5. `TMA_ALLOWED_ORIGINS` –¥–æ–ø–æ–ª–Ω—è–µ—Ç CORS allow-list.

## 3. –õ–æ–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

Backend:

```bash
npm run precommit
npm run start:test
```

Frontend:

```bash
cd tma
npm install
npm run build
```

Smoke-check:

1. `POST /api/auth/tma` (–≤–∞–ª–∏–¥–Ω—ã–π –∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π `initData`),
2. `GET /api/tma/init` —Å `Authorization: Bearer <accessToken>`,
3. –≤ Telegram: `/app`, `/wallet #id`, live-alert –∫–Ω–æ–ø–∫–∞ `üì± TMA`.
4. –≤ Telegram: `/start` —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–º–µ—Ç–Ω—É—é –∫–Ω–æ–ø–∫—É `üì± –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ`, –∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º keyboard –µ—Å—Ç—å `üöÄ Mini App`.
5. –≤ TMA —ç–∫—Ä–∞–Ω `Wallets` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç chain-–±–µ–π–¥–∂–∏ (`ETH/SOL/TRON`) –¥–ª—è –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫.
6. –≤ `WalletDetail` –∫–Ω–æ–ø–∫–∞ `üîï Mute 24h` —Å—Ç–∞–≤–∏—Ç mute, –∞ `üîî Unmute` —Å–Ω–∏–º–∞–µ—Ç –µ–≥–æ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —ç–∫—Ä–∞–Ω–∞.

## 4. –î–µ–ø–ª–æ–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ TMA

–°–±–æ—Ä–∫–∞:

```bash
cd /opt/whale-alert-bot/tma
npm ci
npm run build
```

–ü–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏ –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –∫–∞—Ç–∞–ª–æ–≥:

```text
/opt/whale-alert-bot/tma/dist
```

## 5. Nginx subpath `/tma/`

–ü—Ä–∏–º–µ—Ä –±–ª–æ–∫–∞:

```nginx
location /tma/ {
    alias /opt/whale-alert-bot/tma/dist/;
    try_files $uri $uri/ /tma/index.html;
}
```

–ü—Ä–æ–≤–µ—Ä–∫–∞:

1. `https://1303118-cr22992.tw1.ru/tma/` –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è,
2. `https://1303118-cr22992.tw1.ru/tma/wallets/42` –æ—Ç–¥–∞–µ—Ç SPA (–∞ –Ω–µ 404 nginx).

## 6. BotFather setup

1. –í–∫–ª—é—á–∏—Ç—å Mini App URL –Ω–∞ `https://1303118-cr22992.tw1.ru/tma/`.
2. –î–æ–±–∞–≤–∏—Ç—å Menu Button –¥–ª—è –±–æ—Ç–∞ (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏).
3. –ë–æ—Ç —Ç–∞–∫–∂–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—ã—Ç–∞–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å default menu button –Ω–∞ —Å—Ç–∞—Ä—Ç–µ (–µ—Å–ª–∏ `TMA_BASE_URL` –∑–∞–¥–∞–Ω).
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `startapp` deep-link:
   `https://t.me/<bot_username>?startapp=wallet_42`.

## 7. Production smoke checklist

1. `/health` -> `ok`.
2. `/api/auth/tma` –≤—ã–¥–∞–µ—Ç JWT-–ø–∞—Ä—É.
3. `/api/tma/init` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `wallets + settings + todayAlertCount`.
4. –ö–æ–º–∞–Ω–¥–∞ `/app` –ø—Ä–∏—Å—ã–ª–∞–µ—Ç `web_app` –∫–Ω–æ–ø–∫—É.
5. –ö–Ω–æ–ø–∫–∞ `üì± –û—Ç–∫—Ä—ã—Ç—å –≤ TMA` –≤ `/wallet #id` –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω—É–∂–Ω—ã–π —ç–∫—Ä–∞–Ω.
6. –ö–Ω–æ–ø–∫–∞ `üì± TMA` –≤ alert –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç `wallet_<id>` deep-link.
7. –ö–Ω–æ–ø–∫–∞ `–û—Ç–∫—Ä—ã—Ç—å` –≤ —Å–ø–∏—Å–∫–µ TMA –≤–µ–¥–µ—Ç –Ω–∞ `/wallets/:walletId` –±–µ–∑ –æ—à–∏–±–∫–∏ `–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π id –∫–æ—à–µ–ª—å–∫–∞`.
8. –í –∫–∞—Ä—Ç–æ—á–∫–µ –∫–æ—à–µ–ª—å–∫–∞ –≤ TMA –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å mute/unmute —Ä–∞–±–æ—Ç–∞–µ—Ç end-to-end —á–µ—Ä–µ–∑ API.

## 8. –û—Ç–∫–∞—Ç

1. –ü–æ—Å—Ç–∞–≤–∏—Ç—å `TMA_ENABLED=false`.
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å backend.
3. –û—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—á–µ—Å–∫—É—é —Ä–∞–∑–¥–∞—á—É `/tma/` (–±–µ–∑–æ–ø–∞—Å–Ω–æ), –ª–∏–±–æ –æ—Ç–∫–∞—Ç–∏—Ç—å `tma/dist` –Ω–∞ –ø—Ä–æ—à–ª—É—é –≤–µ—Ä—Å–∏—é.
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ legacy Telegram flow (`/track`, `/list`, `/wallet`, `/history`) –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.

## 9. –ï—Å–ª–∏ –≤ TMA ¬´—á–µ—Ä–Ω—ã–π —ç–∫—Ä–∞–Ω¬ª

–ü—Ä–æ–≤–µ—Ä—å –ø–æ –ø–æ—Ä—è–¥–∫—É:

1. `TMA_ENABLED=true` –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã `TMA_BASE_URL`, `TMA_BOT_USERNAME`, `TMA_ALLOWED_ORIGINS`.
2. `https://<domain>/tma/` –æ—Ç–¥–∞–µ—Ç `200`, –∞ –Ω–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –¥—Ä—É–≥–æ–π –ø—É—Ç—å.
3. `POST https://<domain>/api/auth/tma` –æ—Ç–≤–µ—á–∞–µ—Ç (–¥–ª—è –ø—É—Å—Ç–æ–≥–æ body –æ–∂–∏–¥–∞–µ–º–æ `400`, –Ω–æ –Ω–µ `404`/`502`).
4. –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç `/opt/whale-alert-bot/tma/dist`.
5. –í –ª–æ–≥–∞—Ö app –Ω–µ—Ç –æ—à–∏–±–æ–∫ `TMA auth` –∏ `CORS`.
6. –ï—Å–ª–∏ –µ—Å—Ç—å `400 Invalid Telegram TMA hash`, –ø—Ä–æ–≤–µ—Ä—å –∑–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ `web_app` –∫–Ω–æ–ø–∫–∏ –±–æ—Ç–∞; —Å–µ—Ä–≤–µ—Ä —É–º–µ–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —á–∞—Å—Ç—ã–π –∫–µ–π—Å `query_id` —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –≤–º–µ—Å—Ç–æ `+`, –Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ ‚Äî Telegram launch params.
