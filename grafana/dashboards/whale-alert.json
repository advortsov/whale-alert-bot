{
  "annotations": { "list": [] },
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 1,
  "links": [],
  "panels": [
    {
      "title": "Node.js CPU Usage",
      "description": "Process CPU usage (user + system)",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 8, "x": 0, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "lineWidth": 2, "fillOpacity": 15 },
          "unit": "percentunit",
          "min": 0
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "rate(process_cpu_user_seconds_total[1m])",
          "legendFormat": "user",
          "refId": "A"
        },
        {
          "expr": "rate(process_cpu_system_seconds_total[1m])",
          "legendFormat": "system",
          "refId": "B"
        }
      ]
    },
    {
      "title": "Node.js Memory (RSS & Heap)",
      "description": "Process memory usage",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 8, "x": 8, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "lineWidth": 2, "fillOpacity": 15 },
          "unit": "bytes",
          "min": 0
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "process_resident_memory_bytes",
          "legendFormat": "RSS",
          "refId": "A"
        },
        {
          "expr": "nodejs_heap_size_used_bytes",
          "legendFormat": "Heap Used",
          "refId": "B"
        },
        {
          "expr": "nodejs_heap_size_total_bytes",
          "legendFormat": "Heap Total",
          "refId": "C"
        }
      ]
    },
    {
      "title": "Node.js Event Loop Lag",
      "description": "Event loop lag percentiles",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 8, "x": 16, "y": 0 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "lineWidth": 2, "fillOpacity": 10 },
          "unit": "s",
          "min": 0
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "nodejs_eventloop_lag_p50_seconds",
          "legendFormat": "p50",
          "refId": "A"
        },
        {
          "expr": "nodejs_eventloop_lag_p99_seconds",
          "legendFormat": "p99",
          "refId": "B"
        },
        {
          "expr": "nodejs_eventloop_lag_seconds",
          "legendFormat": "mean",
          "refId": "C"
        }
      ]
    },
    {
      "title": "PostgreSQL Pool Connections",
      "description": "PG connection pool stats",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 8, "x": 0, "y": 8 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "lineWidth": 2, "fillOpacity": 15 },
          "unit": "short",
          "min": 0,
          "decimals": 0
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "pg_pool_connections_total",
          "legendFormat": "total",
          "refId": "A"
        },
        {
          "expr": "pg_pool_connections_idle",
          "legendFormat": "idle",
          "refId": "B"
        },
        {
          "expr": "pg_pool_connections_waiting",
          "legendFormat": "waiting",
          "refId": "C"
        }
      ]
    },
    {
      "title": "Node.js Active Handles & Requests",
      "description": "Active handles and requests in the Node.js process",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 8, "x": 8, "y": 8 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "lineWidth": 2, "fillOpacity": 10 },
          "unit": "short",
          "min": 0,
          "decimals": 0
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "nodejs_active_handles_total",
          "legendFormat": "handles",
          "refId": "A"
        },
        {
          "expr": "nodejs_active_requests_total",
          "legendFormat": "requests",
          "refId": "B"
        }
      ]
    },
    {
      "title": "Node.js GC Duration",
      "description": "Garbage collection duration by type",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 8, "x": 16, "y": 8 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "lineWidth": 2, "fillOpacity": 10 },
          "unit": "s",
          "min": 0
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "rate(nodejs_gc_duration_seconds_sum[5m])",
          "legendFormat": "{{kind}}",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Chain Block Lag",
      "description": "Current block lag per chain watcher",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 16 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "lineWidth": 2, "fillOpacity": 10 },
          "unit": "short"
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "chain_lag_blocks",
          "legendFormat": "{{chain}}",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Chain Queue Size",
      "description": "Block queue size per chain watcher",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 16 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "lineWidth": 2, "fillOpacity": 10 },
          "unit": "short"
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "chain_queue_size",
          "legendFormat": "{{chain}}",
          "refId": "A"
        }
      ]
    },
    {
      "title": "RPC Requests Rate",
      "description": "RPC requests per second by chain and provider",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 24 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "lineWidth": 2, "fillOpacity": 10 },
          "unit": "reqps"
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "rate(rpc_requests_total[5m])",
          "legendFormat": "{{chain}} {{provider}} {{status}}",
          "refId": "A"
        }
      ]
    },
    {
      "title": "RPC Request Duration (p95)",
      "description": "95th percentile RPC latency",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 24 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "lineWidth": 2, "fillOpacity": 10 },
          "unit": "s"
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, rate(rpc_request_duration_seconds_bucket[5m]))",
          "legendFormat": "{{chain}} {{provider}}",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Chain Backoff",
      "description": "Current backoff in ms per chain watcher",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 32 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "lineWidth": 2, "fillOpacity": 10 },
          "unit": "ms"
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "chain_backoff_ms",
          "legendFormat": "{{chain}}",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Rate Limiter Queue",
      "description": "Queue size per rate limiter",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 32 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "lineWidth": 2, "fillOpacity": 10 },
          "unit": "short"
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "rate_limit_queue_size",
          "legendFormat": "{{limiter}}",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Rate Limiter Rejections",
      "description": "Rate limiter rejected requests per second",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 40 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "lineWidth": 2, "fillOpacity": 10 },
          "unit": "reqps"
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "rate(rate_limit_rejected_total[5m])",
          "legendFormat": "{{limiter}}",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Disk Usage %",
      "description": "Root filesystem usage percentage",
      "type": "gauge",
      "gridPos": { "h": 8, "w": 8, "x": 0, "y": 48 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 70 },
              { "color": "red", "value": 85 }
            ]
          },
          "unit": "percent",
          "min": 0,
          "max": 100
        },
        "overrides": []
      },
      "options": {
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        },
        "showThresholdLabels": false,
        "showThresholdMarkers": true
      },
      "targets": [
        {
          "expr": "(1 - node_filesystem_avail_bytes{mountpoint=\"/\",fstype!=\"rootfs\"} / node_filesystem_size_bytes{mountpoint=\"/\",fstype!=\"rootfs\"}) * 100",
          "legendFormat": "usage",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Disk Free",
      "description": "Available disk space on root filesystem over time",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 16, "x": 8, "y": 48 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "lineWidth": 2, "fillOpacity": 15 },
          "unit": "bytes",
          "min": 0
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "node_filesystem_avail_bytes{mountpoint=\"/\",fstype!=\"rootfs\"}",
          "legendFormat": "available",
          "refId": "A"
        },
        {
          "expr": "node_filesystem_size_bytes{mountpoint=\"/\",fstype!=\"rootfs\"}",
          "legendFormat": "total",
          "refId": "B"
        }
      ]
    },
    {
      "title": "Cache Keys",
      "description": "Current number of entries per cache",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 56 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "lineWidth": 2, "fillOpacity": 10 },
          "unit": "short",
          "min": 0,
          "decimals": 0
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "cache_keys",
          "legendFormat": "{{cache}}",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Cache Hit Rate",
      "description": "Cache hit ratio per cache (hits / total lookups)",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 56 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "lineWidth": 2, "fillOpacity": 10 },
          "unit": "percentunit",
          "min": 0,
          "max": 1
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "rate(cache_hits_total[5m]) / (rate(cache_hits_total[5m]) + rate(cache_misses_total[5m]))",
          "legendFormat": "{{cache}}",
          "refId": "A"
        }
      ]
    },
    {
      "title": "History 429 Rate (5m)",
      "description": "History adapter rate limit responses per second",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 64 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "lineWidth": 2, "fillOpacity": 10 },
          "unit": "reqps",
          "min": 0
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "sum by(chain,adapter) (rate(history_history_http_429_total[5m])) or on() vector(0)",
          "legendFormat": "{{chain}} {{adapter}}",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Hot Cache Refresh Success/Fail",
      "description": "Refresh cycles grouped by status and chain",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 64 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "lineWidth": 2, "fillOpacity": 10 },
          "unit": "short",
          "min": 0
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "sum by(chain,status) (rate(history_hot_cache_refresh_total[5m])) or on() vector(0)",
          "legendFormat": "{{chain}} {{status}}",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Hot Cache New vs Duplicate",
      "description": "New cached items vs skipped duplicates",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 72 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "lineWidth": 2, "fillOpacity": 10 },
          "unit": "short",
          "min": 0
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "sum by(chain) (rate(history_hot_cache_new_items_total[5m])) or on() vector(0)",
          "legendFormat": "{{chain}} new",
          "refId": "A"
        },
        {
          "expr": "sum by(chain) (rate(history_hot_cache_duplicate_items_total[5m])) or on() vector(0)",
          "legendFormat": "{{chain}} duplicate",
          "refId": "B"
        }
      ]
    },
    {
      "title": "Hot Cache Coverage (wallets)",
      "description": "Wallets currently stored in Top-100 hot cache",
      "type": "gauge",
      "gridPos": { "h": 8, "w": 6, "x": 12, "y": 72 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "red", "value": null },
              { "color": "yellow", "value": 50 },
              { "color": "green", "value": 90 }
            ]
          },
          "unit": "short",
          "min": 0,
          "max": 100
        },
        "overrides": []
      },
      "options": {
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        },
        "showThresholdLabels": false,
        "showThresholdMarkers": true
      },
      "targets": [
        {
          "expr": "history_hot_cache_wallets_gauge or on() vector(0)",
          "legendFormat": "wallets",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Hot Cache Refresh p95",
      "description": "95th percentile refresh duration by chain",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 6, "x": 18, "y": 72 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "lineWidth": 2, "fillOpacity": 10 },
          "unit": "s",
          "min": 0
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum by(chain,le) (rate(history_hot_cache_refresh_duration_seconds_bucket[5m]))) or on() vector(0)",
          "legendFormat": "{{chain}}",
          "refId": "A"
        }
      ]
    },
    {
      "title": "Hot Cache Avg Items By Chain",
      "description": "Average history items in hot cache entries",
      "type": "timeseries",
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 80 },
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "lineWidth": 2, "fillOpacity": 10 },
          "unit": "short",
          "min": 0
        },
        "overrides": []
      },
      "targets": [
        {
          "expr": "history_hot_cache_entry_items_gauge or on() vector(0)",
          "legendFormat": "{{chain}}",
          "refId": "A"
        }
      ]
    }
  ],
  "refresh": "30s",
  "schemaVersion": 39,
  "tags": ["whale-alert"],
  "templating": { "list": [] },
  "time": { "from": "now-1h", "to": "now" },
  "timepicker": {},
  "timezone": "browser",
  "title": "Whale Alert Bot",
  "uid": "whale-alert-main"
}
